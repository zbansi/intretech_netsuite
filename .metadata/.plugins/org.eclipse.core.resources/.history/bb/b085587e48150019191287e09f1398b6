/**
 * @NApiVersion 2.x
 * @NScriptType Suitelet
 * @NAmdConfig ./configuration.json
 * 
 * Sample 2.0 Suitelet to invoke restlet using Token-based Authentication
 */
define(
		[ 'N/https', 'oauth', 'cryptojs' ],
		/**
		 * @param {https} https
		 * @param {oauth} oauth
		 * @param {cryptojs} cryptojs
		 */
		function(https, crypto, oauth, cryptojs) {
			function testRequest(context) {
				if (context.request.method == 'GET') {
					// Endpoint URL
					var requestUrl = 'https://5144758-sb1.restlets.api.netsuite.com/app/site/hosting/restlet.nl?script=24&deploy=1';// REST

					// //////////// TOKEN-BASED AUTHENTICATION///////////
					// client credentials
					var consumerKey = 'a4fca249a4ec7d7be1f85b4f9177ad79756df96415c1ad08439592984fed2ab5';
					var consumerSecret = 'a56ede1ee3ea34d0fa85b112568f3d178c63e72a6fe20819bb2463d0d8d081d4';
					// token credentials
					var tokenId = 'e0e754dd5542f58fed363616fea11803d4910e4a1350835001f0b9f0fa3e6d25';
					var tokenSecret = '754086c49441d2b4a218349ab89e5fc15e850024db7346b5401efac3c02d8b55';
					// REALM
					var realm = '5144758_SB1';

					var reqBody = {
						"a_parameter" : 'abc123',
					};

					// ////////// USER CREDENTIALS/////////////
					var email = '377132229@qq.com';
					var signature = 'Welcome123';
					var roleId = 1002;// 用户角色需要访问货品的权限

					// Build Token-Based Authorization
					var auth = OAuth({
						consumer : {
							key : consumerKey,
							secret : consumerSecret
						},
						signature_method : 'HMAC-SHA256',
						hash_function : hashfunctionsha256
					});

					var token = {
						key : tokenId,
						secret : tokenSecret
					};
					var data = getQueryParams(requestUrl);

					var request_data = {
						url : requestUrl,
						method : 'GET', // default GET
						data : data,
						includeBodyHash : false
					// default false
					};

					var authHead = auth.toHeader(auth.authorize(request_data,
							token));
					var reqHeaders = {
						'Content-Type' : 'application/json',
						'Authorization' : authHead.Authorization + ', realm="'
								+ realm + '"'
					};
					try {
						var req = https.post({
							url : requestUrl,
							body : JSON.stringify(reqBody),
							headers : reqHeaders
						});
					} catch (err) {
						log.debug({
							title : err.name,
							details : err.message
						});
					}
					/*
								var reqHeaders2 = {
									'Content-Type' : 'application/json',
									'Authorization' : 'OAuth realm="' + realm + '", ' + 'oauth_consumer_key="a4fca249a4ec7d7be1f85b4f9177ad79756df96415c1ad08439592984fed2ab5", '
											+ 'oauth_token="e0e754dd5542f58fed363616fea11803d4910e4a1350835001f0b9f0fa3e6d25", '
											+ 'oauth_nonce="9YwRJYIXNbD2gy5BuasNSnXUrF2qpEWT", ' + 'oauth_timestamp="1547102755", ' + 'oauth_signature_method="HMAC-SHA256", '
											+ 'oauth_version="1.0", '
											+ 'oauth_signature="ZGVkZDAzNTFkMTJkZTM1ZWQyYWZjZWJlMzY4NGM0NWIyOGE5ZWE3ZjU1MmRhNGY2ZmY3ZGI3M2NiNzNjMjRmYw=="'
								}
								var rep2 = https.post({
									url : requestUrl,
									body : JSON.stringify(reqBody),
									headers : reqHeaders2
								});
					*/
					// Build User Credentials Authorization
					var reqHeaders3 = {
						'Content-Type' : 'application/json',
						'Authorization' : 'NLAuth nlauth_account=' + realm
								+ ', nlauth_email=' + email
								+ ', nlauth_signature=' + signature
								+ ', nlauth_role=' + roleId
					};

					var rep3 = https.get({
						url : requestUrl,
						headers : reqHeaders3
					});

					log.debug({
						title : 'Resp',
						details : 'OAuth POST响应1:' + req.body
						// + 'OAuth GET响应2: ' + rep2.body
						+ 'NLAuth响应3: ' + rep3.body
					});

					var html = '<html><body>' + 'Calling: ' + requestUrl
							+ '<br><br>' + 'Generated OAuth header:<br>'
							+ authHead.Authorization + ', realm="' + realm
							+ '"' + '<br><br>' + 'Full header1 stack:<br>'
							+ JSON.stringify(reqHeaders) + '<br><br>'
							//+ 'Full header2 stack:<br>'
							//+ JSON.stringify(reqHeaders2) + '<br><br>' 
							+ 'Payload:<br>' + JSON.stringify(reqBody)
							+ '<br><br>' + 'OAuth POST Response1:<br>'
							+ req.body + '<br><br>'
							//+ 'OAuth GET Response2:<br>' + rep2.body + '<br><br>' 
							+ 'NLAuth Response3:<br>' + rep3.body
							+ '</body></html>';

					context.response.write(html);
				}
			}

			function hashfunctionsha256(base_string, key) {
				return CryptoJS.HmacSHA256(base_string, key).toString(
						CryptoJS.enc.Base64);
			}

			function getQueryParams(url) {
				if (typeof url !== 'string') {
					throw TypeError("getQueryParams requires a String argument.")
				}

				var paramObj = {};

				if (url.indexOf('?') === -1) {
					return paramObj;
				}

				// Trim any anchors
				url = url.split('#')[0];

				var queryString = url.split('?')[1];
				var params = queryString.split('&');
				for ( var i in params) {
					var paramString = params[i];
					var keyValuePair = paramString.split('=');
					var key = keyValuePair[0];
					var value = keyValuePair[1];

					if (key in paramObj) {
						if (typeof paramObj[key] === 'string') {
							paramObj[key] = [ paramObj[key] ]
						}
						paramObj[key].push(value);
					} else {
						paramObj[key] = value;
					}
				}
				return paramObj;
			}

			return {
				onRequest : testRequest
			};
		});